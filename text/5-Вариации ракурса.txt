2......................................
Ниже описывается способ представления освещения при помощи сферических гармоник. В данной работе рассматривается диффузная модель освещения при которой яркость точки поверхности можно представить в виде:

<B(p) = ... форм. диффуз осв. > 2.1

где B(p) - отраженный свет, n - нормаль к поверхности в точке p, L(\omega) - oсв.

В [рамамурти_сф_гарм]  описывается подход к анализу изображений трёхмерных объектов, основанный на разложении B(p) на сферические гармоники. Сферические гармоники представляют собой набор функций, формирующих отртонормированный базис для функций заданных на единичной сфере (к каким можно отнести и функцию (2.1)). 

Сферические гармоники Y\sup(lm) задаются в виде:

<формула сф. гармоник> (2.2)

Первые 3 порядка выглядят следующим образом:

<9 формул> (2.3-2.11)

Для анализа освещённости формулы 2.3 - 2.11 можно записать как функции проекций орта нормали:

<9 формул> (2.12-2.20)

В [джанг сф. гарм.] показано, что для разложения освещённости объектов достаточно вышепреведённых первых девяти функций. Таким образом, изображение можно представить в виде: 
<formula I=B'*alpha+E> 2.21
где I - вектор-столбец пикселей изображения размерности d, B - матрица размерности 9*d, где каждая строка соответствует сферической гармонике, \alpha - вектор-столбец коэффициентов разложения размерности 9, E - вектор-столбец размерности d, содержащий невязку между реальным изображением и линейной комбинацией \B'*alpha. При этом вся информация об условиях освещения содержится в векторе \alpha, а матрица B содержит информацию о форме поверхности, которая, очевидно, не зависит от условий освещения и может быть использована в качестве информативных признаков, инвариантных к освещению.

На рис 2.1 показан пример разложения изображения на сферические гармоники.

<рис 2.1>

Далее в части 3 приведён алгоритм восстановления коеффициентов разложения на сферические гармоники для изображения с произвольным освещением, а в части 4 описан способ восстановления базисных изображений. 

3.............................
В этой части описывается алгоритм восстановления коэффициентов разложения изображения произвольного субъекта, взятого с произвольным освещением на сферические гармоники 2.12 - 2.20, основанный на результатах, полученных в [джанг сф. гарм.].

3.1 Вычисление статистических характеристик базисных изображений 

Исходными данными для получения коеффициентов разложения \alpha и базисных изображений для изображения произвольного субъекта, взятого с произвольным освещением являются статистические характеристики разложения 2.21, изученные по предварительно известным 3d моделям лиц. На рис 3.1 приводится схема алгоритма вычисления анализа необходимых данных по набору 3D моделей.

%Рис 3.1%

В начале имеется m 3d моделей.
На первом шаге для каждой 3d модели в анализируемом изображении вычиляются проекции орта нормали (nx, ny, nz), соответствующие пикселам изображений (по d векторов для какждой модели, где d - количество пикселей).
На втором шаге для каждой модели вычилслются 9 базисных изображений по форомулам 2.12-2.20 BjL_ l=1..m,j=1..9
На третьем шаге вычилсляется оценка математического ожидания для каждого из девяти базисных изображении \\uBj,k j=1..9 и матрицы ковариации для каждого элемента изображения (d матриц Cb) 
На четвёртом шаге вычисленные на первом шаге нормали используются для генерации изображений IK,I для n различныч условий освещения (всего генерируется n*m различных изображений). 
На пятом шаге для каждого из n условий освещения производится оценка коэффициентов \alphaKj , а также ошибка EKl  k=1..n, l=1..m, j=1..9. Оценка производится методом наименьших квадратов: коэффициенты \alphaKj выбираются таким образом, чтобы при заданном k минимизировать квадрат ошибки \EallK^2 в уравнении \IallK=Ball'*alphaK + Eall, где IallK,  EallK, Ball получаются конкатенацией IKl, EKl, BK для всех субъектов при фиксированном k.
На шестом шаге для каждого из n условий освещения вычисляется среднее значение и дисперсия ошибки \uEKl, \sigmaEKl

Результатом произведённых вычислений являются матрица \uBji, d матриц ковариации Cb, а также для каждого k-ого из n условий освещения \alphaK, \uEK, \sigmaEK, m векторов IK,I.

3.2 Восстановление коеффициентов разложения.

Для восстановления коеффициентов \альфа разложения 2.21 для изображения произвольного субъекта, взятого с произвольным освещением производится аппрок данные, полученные в предыдущем пункте. Оценку коэффициентов \alphaNOVEL для изображения Inovel в формуле 2.21 можно получить методом ядерной регрессии ([zang sph harm]):

\alphaNOVEL_ = \sum(k=1..n|\sum(i=1..m|wki*\alphaK_) ) / \sum(k=1..n|\sum(i=1..m|wki) ) 3.1

где wki = \exp(-1/2*(D(I@k,i@, Inovel)/\sigma@k,i@)^2), D(I1_, I2_) = \sqrt( (I2-I1)^2 ), k - номер предварительно изученного условия освещения , i - номер предварительно изветсной модели, n - количество предварительно изученных условий освещения, m - количество предварительно известных моделей (см. пункт 3.1). Ширина Гауссового ядра, соответствующего изображению k,i, \sigma@k,i@ выбирается таким образом, чтобы приблизительно десятая часть изображений I@k', j'@ соответствовала условию D(I@k,j@_, I@k', j'@) < \sigma@k,i@.

Схожим образом можно получить оценку \uEnovel_ и \sigmaENOVEL^2_:

\uEnovel_ = \sum(k=1..n|\sum(i=1..m|wki*\uEk_) ) / \sum(k=1..n|\sum(i=1..m|wki) ) 3.2

\sigmaENOVEL_ = \sum(k=1..n|\sum(i=1..m|wki*\sigmaENOVELK__) ) / \sum(k=1..n|\sum(i=1..m|wki) ) 3.3

Далее в части 4 описывается алгоритм, позволяющий на основании полученных \alphaNOVEL_, \uEnovel_, \sigmaENOVEL_ оценить BNOVEL_.



Для восстановления базисиных изображений BNOVEL_i для изображения INOVELi предпологается, что B_i - случайная величина, имеющая нормальное распределение (здесь i обозначает номер пиксела). Получение оценки параметров этого рапсределения (математического ожидания и матрицы ковариации) описана в пункте 3.1. Значение BNOVEL_i ищется как величина, имеющая максимальную апостериорную вероятность при заданном INOVELi:

BNOVEL_i = argmax\sub{B_i}(P(B_i|Ii))      4.1

Используя теорему Байеса можно записать:

P(B_i|Ii)*P(Ii) = P(Ii|B_i)*P(B_i)         4.2

Так как коеффициенты \alphaNOVEL_ разложения 2.21 уже известны (см. пункт 3.2), вероятность P(INOVELi) можно считать постоянной. Тогда, подставив 4.2 в 4.1, можно записать:

BNOVEL_i = argmax\sub{B_i}(p(B_i|INOVELi)) = argmax\sub{B_i}(p(B_i|INOVELi)*p(INOVELi)) = argmax\sub{B_i}(P(INOVELi|B_i)*P(B_i))

BNOVEL_i = argmax\sub{B_i}(p(INOVELi|B_i)*p(B_i)) 4.3

Если считать, что INOVELi случайная величина, распределённая нормально, то, в соответствии с 2.21, при заданном BNOVEL_i и известном \alphaNOVEL_ её математическое ожидание будет равно BNOVEL_i'*\alphaNOVEL_+\uEnoveli, а дисперсия будет равна \sigmaENOVELi^2 (где \uEnoveli, и \sigmaENOVELi^2 - математическое ожидание и дисперсия ошибки при заданных условиях освещения, полученные в пункте 3.2), а плотность распределения будет выражатся лседующим образом:

p(INOVELi|B_i) = 1/(\sigmaENOVELi*\sqrt(2*\pi))*\exp(-1/2*(INOVELi-BNOVEL_i'*\alphaNOVEL_-\uEnoveli)^2/\sigmaENOVELi^2) 4.4

Считая B_i нормально распределеннной случайной величиной, можно записать

p(B_i) = 1/sqrt(det(Cbi)*(2\pi)^s)*\exp(-1/2*(B_i-\uB_i)'*Cbi^-1*(B_i-\uB_i))   4.5

где s - количество взятых сферических гармоник (Размерность векторов B_i, \uB_i равна s, а матрицы Сbi равна s\*s)

Подставляя 4.4 и 4.5 в 4.3 можно получить 

BNOVEL_i = argmax\sub{B_i}(A*\exp(-1/2*(INOVELi-BNOVEL_i'*\alphaNOVEL_-\uEnoveli)^2/\sigmaENOVELi^2)*\exp(-1/2*(B_i-\uB_i)'*Cbi^-1*(B_i-\uB_i)))

где A = 1/(sqrt(det(Cbi)*\sigmaENOVELi^2*(2\pi)^(s+1)))

Так как множитель A не зависит от B_i его можно не учитывать при максимизации, т.е

BNOVEL_i = argmax\sub{B_i}(\exp(-1/2*(INOVELi-BNOVEL_i'*\alphaNOVEL_-\uEnoveli)^2/\sigmaENOVELi^2)*\exp(-1/2*(B_i-\uB_i)'*Cbi^-1*(B_i-\uB_i))) 4.6

Очевидно, что 

BNOVEL_i = argmax\sub{B_i}(\exp(-1/2*(INOVELi-BNOVEL_i'*\alphaNOVEL_-\uEnoveli)^2/\sigmaENOVELi^2)*\exp(-1/2*(B_i-\uB_i)'*Cbi^-1*(B_i-\uB_i))) = 
= argmax\sub{B_i}((-1/2*INOVELi-BNOVEL_i'*\alphaNOVEL_-\uEnoveli)^2/\sigmaENOVELi^2-1/2*(B_i-\uB_i)'*Cbi^-1*(B_i-\uB_i)) 4.7

Для нахождения максимума в правой части выражения 4.7 необходимо приравнять к нулю произвожные по bi_:

-1/\sigmaENOVELi^2*(INOVELi-BNOVEL_i'*\alphaNOVEL_-\uEnoveli)*\alphaNOVEL_+Cbi^-1*(B_i-\uB_i)=0 4.8

После раскрытия скобок в 4.8 можно получить:

<уравнение для BNOVEL_i> 4.9

Решение 4.9 

BNOVEL_i = ... 4.10

Является приблизительной оценкой базисных изображений для данного Inovel.


----------------------------------------------------------- Начало

В данной части описывается подход к анализу изображений лица человека взятого под произвольным рукурсом, основанный на результатах предыдущих частей.

Алгоритмы, описанные в третьей и четвёртой частях, позволяют выделить инвариантные к условиям освещения признаки для изображения, взятого под определённым ракурсом. Для выделения признаков, инвариантных к изменениям ракурса в [жанг сф гар] предлагается использовать метод, основанный на трансформируемых 3D моделях лица (Morphable 3D Model). В [жанг сф гар] показано, что этот метод даёт хорошие результаты при вариации ракурса. Недостатком трансформируемых 3D моделяй лица является необходимость ручного задания положения характерных точек на исследуемом изображении лица. Это затрудняет использование трансформируемых 3D моделей на крупных базах изображений. Для решения этой проблемы в данной работе предлагается следующий подход. 

В части 3 описывается метод получения оценки сферических гармоник для изображения некоторого произвольного субъекта. В сферических гармониках содержится информация о форме поверхности изображённого лица. Очивидно, что гармоника задаваемая формулой 2.12 никакой информации не несёт. Пронумеруем гармоники, задаваемые формулами 2.13-2.20 от 1 до 8. Пусть bji' - вычисленные значения базисных гармоник тренировочного лица, где j - номер используемой гармоники, i - номер пикселя, содержащие в себе некоторую погрешность eji:

eji = bji'-bji(n_)  5.1
  
где n_ - вектор нормали в точке i. 

Полную ошибку Ei в точке i можно представить следующим образом:

Ei = \sum(j=1..8 eji^2/2) = \sum(j=1..8 (bji'-bji(n_))^2/2) 5.2

Вектор n_ минимизирующий Ei можно найти методом градиентного спуска. Производная Ei(n_)/\dn_ выглядит следующим образом:

ююююююююююююю               5.3

db1/dn_ = , ...      5.4
		     5.5-5.11

Восстановив вектор нормали n_ в каждой точке поверхности можно затем аппроксимировать саму поверхность.
По полученной таким сбособом поверхности имеется возможность получить базисные изображения для различных ракурсов для тренировочного набора. 
Для обучения классификатора можно использовать значения базисных гармоник тренировочных изображений в различных ракурсах.

